Bootstrap: docker
From: nvidia/cuda:12.1.0-devel-ubuntu22.04

%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y python3.10 python3.10-venv python3.10-dev git wget python3-pip nano

    # Upgrade pip
    python3.10 -m pip install --upgrade pip==22.3.1

    # Core dependencies
    python3.10 -m pip install absl-py==0.11.0
    python3.10 -m pip install numpy==1.22.4
    python3.10 -m pip install typing-extensions==4.13.2
    python3.10 -m pip install scipy==1.9.3
    python3.10 -m pip install tensorflow==2.10.0
    python3.10 -m pip install tensorboardX==2.6
    python3.10 -m pip install tqdm==4.66.5
    python3.10 -m pip install click

    # Compatible PyTorch + torchvision for Opacus
    python3.10 -m pip install torch==2.0.1 torchvision==0.15.2

    # Correct scikit-learn version
    python3.10 -m pip install scikit-learn==1.1.3

    # Other libraries
    python3.10 -m pip install matplotlib==3.6.1
    python3.10 -m pip install omegaconf==2.1.1
    python3.10 -m pip install fedlab==1.3.0
    python3.10 -m pip install pandas==2.0.3
    python3.10 -m pip install opacus==1.5.3
    python3.10 -m pip install Pillow==9.2.0
    python3.10 -m pip install psutil==6.0.0
    python3.10 -m pip install Pympler==1.1
    python3.10 -m pip install sewar==0.4.6
    python3.10 -m pip install tenseal==0.3.15
    python3.10 -m pip install ninja==1.10.2
    
    python3.10 -m pip install GPUtil

    # Virtual environment for opacus_dpdm
    python3.10 -m venv /opt/opacus_venv
    /opt/opacus_venv/bin/pip install --upgrade pip==22.3.1
    /opt/opacus_venv/bin/pip install -e git+https://github.com/timudk/opacus_dpdm.git@dpdm#egg=opacus

%environment
    export TERM=xterm
    export PYTHONPATH=/opt/opacus_venv/:$PYTHONPATH
